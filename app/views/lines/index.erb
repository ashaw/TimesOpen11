<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/javascripts/raphael.js"></script>
<script type="text/javascript" src="/javascripts/underscore.js"></script>

<a id="switcher" href="#">WOOOO</a>

<div id="happyCanvas" style="background:url('/images/lines-bg.png')"></div>
<div id="sadCanvas" style="background:url('/images/lines-bg.png')"></div>

<script type="text/javascript">
	// appologies_for_variables_with_underscores

	var size = 500,
		cols = 5,
		radius = 10,
		margin = Math.round(size / cols),
		max_radius = (margin / 2) * 1.2,
		x, y,
		max_happy, min_happy

	var lines = <%= raw @lines %>;
	// console.log(lines)

	lines = _.map(lines, function(x) { return x['line'] })

	max_happy = _.max(lines, function(line) { return line['happiness'] })['happiness'];
	min_happy = _.min(lines, function(line) { return line['happiness'] })['happiness'];
	happy_range = max_happy - min_happy

	max_sad = _.max(lines, function(line) { return line['sadness'] })['sadness'];
	min_sad = _.min(lines, function(line) { return line['sadness'] })['sadness'];
	sad_range = max_sad - min_sad

	var h_array = _.map(lines, function(line) { return max_radius * normalize_happiness(line['happiness'])})
	var s_array = _.map(lines, function(line) { return max_radius * normalize_sadness(line['sadness'])})

	var happyPaper = Raphael("happyCanvas", size, size);

	var circles = []

	$.each(lines, function(index, line) {
		// console.log(line)
		x = (margin / 2) + ((index % 5) * margin)
		y = (margin / 2) + (Math.floor(index / cols) * margin)

		circle = happyPaper.circle(x, y, h_array[index]);
		circle.attr("fill", "#349d2c");
		circle.attr("opacity", 0.75);
		circle.attr("stroke-width", 0);
		happyPaper.image('/images/homepage_stops/' + line_img(line['name']) + '.png', x-19, y-18, 40, 40);

		circles.push(circle);

	})

	$('#switcher').hover(function() {
		$.each(circles, function(index, circle) {
			circle.animate(
				{ r: s_array[index], fill:'#d93130' },
				400
			)
		})
	}, function() {
		$.each(circles, function(index, circle) {
			circle.animate(
				{ r: h_array[index], fill:"#349d2c" },
				400
			)
		})
	});


	function normalize_happiness(happy) {
		return (happy - min_happy) / happy_range
	}

	function normalize_sadness(sad) {
		return (sad - min_sad) / sad_range
	}

	function line_img(line_name) {
	    return (line_name.length > 1 || line_name == "H") ? "S" : line_name
  	}




</script>